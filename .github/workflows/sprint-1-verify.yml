name: Sprint 1 Verification

on:
  workflow_dispatch:
    inputs:
      force-rebuild:
        description: 'Force rebuild all images'
        required: false
        default: 'false'

jobs:
  verify-infra:
    name: Verify Infrastructure Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check file structure
        run: |
          echo "Checking project structure..."
          ls -la
          ls -la apps/
          ls -la packages/

      - name: Verify configuration files
        run: |
          echo "Verifying configuration files..."
          test -f package.json
          test -f pnpm-workspace.yaml
          test -f tsconfig.base.json
          test -f turbo.json
          test -f docker-compose.yml
          test -f .env.example

      - name: Verify database schema
        run: |
          echo "Verifying Prisma schema..."
          test -f packages/database/prisma/schema.prisma

      - name: Verify Docker configurations
        run: |
          echo "Verifying Docker configurations..."
          test -f docker/prometheus/prometheus.yml
          test -f docker/postgres/init.sql
          test -f docker/grafana/provisioning/datasources/datasources.yml

      - name: Verify CI/CD pipeline
        run: |
          echo "Verifying CI/CD pipeline..."
          test -f .github/workflows/ci.yml

  verify-services:
    name: Verify Services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8.10.0'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: |
          echo "Building packages..."
          cd packages/config && pnpm build
          cd ../logger && pnpm build
          cd ../errors && pnpm build
          cd ../shared-types && pnpm build
          cd ../database && pnpm build

      - name: Build API Gateway
        run: |
          echo "Building API Gateway..."
          cd apps/api-gateway && pnpm build

      - name: Build Auth Service
        run: |
          echo "Building Auth Service..."
          cd apps/auth-service && pnpm build

  summary:
    name: Sprint 1 Summary
    runs-on: ubuntu-latest
    needs: [verify-infra, verify-services]
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "Sprint 1 Infrastructure Verification Complete"
          echo "============================================="
          echo ""
          echo "Verified:"
          echo "  - Project structure with pnpm workspaces"
          echo "  - TypeScript configuration"
          echo "  - ESLint and Prettier configuration"
          echo "  - Docker Compose for local development"
          echo "  - Prisma database schema"
          echo "  - CI/CD pipeline"
          echo "  - API Gateway service"
          echo "  - Auth Service"
          echo ""
          echo "All tasks for Sprint 1 (Foundation & Infrastructure) completed!"
